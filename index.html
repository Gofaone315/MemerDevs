<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="copyright" content="Copyright ¬© 2024 Gofaone Tlalang. All rights reserved.">
    <link rel="shortcut icon" href="/../logo.ico" type="image/x-icon">
    <title>MemerDevs Posts</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        .post {
            background: white;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .post p {
            font-size: 16px;
        }
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            background-color: #007BFF;
        }
        .buttons button:hover {
            background-color: #0056b3;
        }
        .comments-section {
            margin-top: 20px;
        }
        #search-box {
            position: fixed;
            top: 0px;
            left: 0px;
            background-color: #ededed;
            padding: 10px 10px;
            width: 100%;
        }
        #search-box input {
            width: 83%;
            border-radius: 5px;
            border-color: #007bff;
            padding: 10px 10px;
        }
        #search-box input:hover {
            background-color: #063ffc4;
        }
        #search-box input:focus {
            box-shadow: 0 0 0 1.1px rgba(0, 0, 240, 1);
        }
        #search-box button {
            border-radius: 5px;
            border-color: #007bff;
            padding: 10px 10px;
        }
    </style>
</head>
<body>
<div id="search-box">
    <input type="search" placeholder="Search for posts" name="post-search" id="post-search">
    <button onclick="performSearch()">üîç</button>
</div>
<div id="posts-container">
    <!-- Posts will be dynamically loaded here -->
</div>

<script>
    fetch('http://localhost:5000/get_username')
        .then(response => response.json())
        .then(data => {
            const username = data.username;
            console.log("Current User:", username);

    function loadPosts() {
        fetch('http://localhost:5000/get_posts')
        .then(response => response.json())
        .then(posts => {
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = '';

            for (let post_key in posts) {
                let post = posts[post_key];

                let postElement = document.createElement('div');
                postElement.className = 'post';

                postElement.innerHTML = `
                    <h3>${post.username}</h3>
                    <p>${post.text}</p>
                    ${post.media_url ? `<div>${post.media_url.endsWith('.mp4', '.webm', '.avi', 'mpeg') ? `<video controls src="${post.media_url}" style="width: 100%;"></video>` : `<img src="${post.media_url}" style="width: 100%;">`}</div>` : ''}
                    <div class="buttons">
                        <button onclick="likePost('${post_key}')">&#128077; Like (${post.likes ? post.likes.length : 0})</button>
                        <button onclick="showComments('${post_key}')">&#128172; Comments</button>
                        ${post.media_url ? `<button onclick="downloadMedia('${post.media_url}')">&#x2B07; Download</button>` : ''}
                    </div>
                    <div id="comments-${post_key}" class="comments-section"></div>
                `;

                postsContainer.appendChild(postElement);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function likePost(post_key) {
        fetch('http://localhost:5000/like_post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ post_key: post_key, username: username })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.message);
            loadPosts();  // Reload posts to update like counts
        })
        .catch(error => console.error('Error:', error));
    }

    function downloadMedia(media_url) {
        fetch('http://localhost:5000/download_media', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ media_url: media_url })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
        })
        .catch(error => console.error('Error:', error));
    }

    function showComments(post_key) {
        fetch('http://localhost:5000/get_comments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ post_key: post_key })
        })
        .then(response => response.json())
        .then(comments => {
            const commentsSection = document.getElementById(`comments-${post_key}`);
            commentsSection.innerHTML = '';

            comments.forEach(comment => {
                let commentElement = document.createElement('div');
                commentElement.innerHTML = `<strong>${comment.username}</strong>: ${comment.text}`;
                commentsSection.appendChild(commentElement);
            });

            // Add comment input and button
            commentsSection.innerHTML += `
                <input type="text" id="new-comment-${post_key}" placeholder="Add a comment" style="width: 80%;">
                <button onclick="addComment('${post_key}')">Add Comment</button>
            `;
        })
        .catch(error => console.error('Error:', error));
    }

    function addComment(post_key) {
        const commentText = document.getElementById(`new-comment-${post_key}`).value;

        if (commentText.trim() !== '') {
            fetch('http://localhost:5000/add_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    post_key: post_key,
                    comment_text: commentText,
                    username: username
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
                showComments(post_key);  // Reload comments after adding a new one
            })
            .catch(error => console.error('Error:', error));
        } else {
            alert('Comment text cannot be empty.');
        }
    }
    // Initial load of posts
    loadPosts();
    
function performSearch() {
    console.log("performing search...")
    // Get the search input value
    const searchInput = document.getElementById('post-search').value.toLowerCase();
    fetch('http://localhost:5000/search_posts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ search_input: searchInput })
    })
    .then(response => response.json())
    .then(posts => {
        const postContainer = document.getElementById('postContainer');
        postContainer.innerHTML = '';

        // If there are matching posts
        if (posts.length > 0) {
            posts.forEach(post => {
                let postElement = document.createElement('div');
                postElement.className = 'post';

                postElement.innerHTML = `
                    <h3>${post.username}</h3>
                    <p>${post.text}</p>
                    ${post.media_url ? `<div>${post.media_url.endsWith('.mp4', '.webm', '.avi', 'mpeg') ? `<video controls src="${post.media_url}" style="width: 100%;"></video>` : `<img src="${post.media_url}" style="width: 100%;">`}</div>` : ''}
                    <div class="buttons">
                        <button onclick="likePost('${post.post_key}')">&#128077; Like (${post.likes ? post.likes.length : 0})</button>
                        <button onclick="showComments('${post.post_key}')">&#128172; Comments</button>
                        ${post.media_url ? `<button onclick="downloadMedia('${post.media_url}')">&#x2B07; Download</button>` : ''}
                    </div>
                    <div id="comments-${post.post_key}" class="comments-section"></div>
                `;

                postContainer.appendChild(postElement);
            });
        } else {
            // If no posts are found
            postContainer.innerHTML = '<p>No results found.</p>';
        }
    })
    .catch(error => console.error('Error:', error));
}
});
</script>
</body>
</html>